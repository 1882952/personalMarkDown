### 主机之间的通信方式

1. 客户-服务端（c/s）架构： 客户是服务的请求方，服务器是服务的提供方：

2. 对等（P2P）：不区分客户端与服务端。

# 一：计算机网络结构简介

![images\计算机网络体系结构](images\计算机网络体系结构.png)

### 1:七层协议：

如图 a 所示，其中表示层和会话层用途如下：

1. 表示层：信息的语法、语义以及它们的关联，如加密解密、转换翻译、压缩解压缩；
2. 会话层：不同机器上的用户之间建立及管理会话。

### 2:五层协议

1. 应用层：为特定应用程序提供数据传输服务，，例如 HTTP、DNS 等。数据单位为报文。

2. 运输层：提供的是进程间的通用数据传输服务。由于应用层协议很多，定义通用的运输层协议就可以支持不断增多的应用层协议。运输层包括两种协议：传输控制协议 TCP，提供面向连接、可靠的数据传输服务，数据单位为报文段；用户数据报协议 UDP，提供无连接、尽最大努力的数据传输服务，数据单位为用户数据报。TCP 主要提供完整性服务，UDP 主要提供及时性服务。

3. 网络层：为主机之间提供数据传输服务，而运输层协议是为主机中的进程提供服务。网络层把运输层传递下来的报文段或者用户数据报封装成分组。

4. 数据链路层：网络层针对的还是主机之间的数据传输服务，而主机之间可以有很多链路，链路层协议就是为同一链路的结点提供服务。数据链路层把网络层传来的分组封装成帧。

5. 物理层：考虑的是怎样在传输媒体上传输数据比特流，而不是指具体的传输媒体。物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。

## TCP/IP体系结构

它只有四层，相当于五层协议中数据链路层和物理层合并为网络接口层。

现在的 TCP/IP 体系结构不严格遵循 OSI 分层概念，应用层可能会直接使用 IP 层或者网络接口层。

![计算机网络 - 图11](https://static.bookstack.cn/projects/Interview-Notebook/pics/45e0e0bf-386d-4280-a341-a0b9496c7674.png)

TCP/IP 协议族是一种沙漏形状，中间小两边大，IP 协议在其中占用举足轻重的地位。

![计算机网络 - 图12](https://static.bookstack.cn/projects/Interview-Notebook/pics/d4eef1e2-5703-4ca4-82ab-8dda93d6b81f.png)





# 二：数据链路层

## 信道分类

1. 点对点信道：一对一通信方式；
2. 广播信道：一对多通信方式。

## 三个基本问题

### 1：封装为帧

将网络层传下来的分组添加首部和尾部，用于标记帧的开始和结束。

![计算机网络 - 图27](https://static.bookstack.cn/projects/Interview-Notebook/pics/ea5f3efe-d5e6-499b-b278-9e898af61257.jpg)

### 2. 透明传输

透明表示一个实际存在的事物看起来好像不存在一样。

帧使用首部和尾部进行定界，如果帧的数据部分含有和首部尾部相同的内容，那么帧的开始和结束位置就会被错误的判定。需要在数据部分出现首部尾部相同的内容前面插入转义字符，如果出现转移字符，那么就在转义字符前面再加个转义字符，在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。

![计算机网络 - 图28](https://static.bookstack.cn/projects/Interview-Notebook/pics/c5022dd3-be22-4250-b9f6-38ae984a04d7.jpg)

### 3. 差错检测

目前数据链路层广泛使用了循环冗余检验（CRC）来检查比特差错。



## MAC 层*

MAC 地址是 6 字节（48 位）的地址，用于唯一标识网络适配器（网卡），一台主机拥有多少个适配器就有多少个 MAC 地址，例如笔记本电脑普遍存在无线网络适配器和有线网络适配器。

![计算机网络 - 图36](https://static.bookstack.cn/projects/Interview-Notebook/pics/50d38e84-238f-4081-8876-14ef6d7938b5.jpg)

在 MAC 帧中：

- **类型**  ：标记上层使用的协议；
- **数据**  ：长度在 46-1500 之间，如果太小则需要填充；
- **FCS**  ：帧检验序列，使用的是 CRC 检验方法；
- **前同步码**  ：只是为了计算 FCS 临时加入的，计算结束之后会丢弃。



# 三：网络层

## 网际协议 IP 概述

因为网络层是整个互联网的核心，因此应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。

使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。

![计算机网络 - 图37](https://static.bookstack.cn/projects/Interview-Notebook/pics/7b038838-c75b-4538-ae84-6299386704e5.jpg)

与 IP 协议配套使用的还有三个协议：

1. 地址解析协议 ARP（Address Resolution Protocol）
2. 网际控制报文协议 ICMP（Internet Control Message Protocol）
3. 网际组管理协议 IGMP（Internet Group Management Protocol）

![计算机网络 - 图38](https://static.bookstack.cn/projects/Interview-Notebook/pics/0a9f4125-b6ab-4e94-a807-fd7070ae726a.png)

## IP 数据报格式

![计算机网络 - 图39](https://static.bookstack.cn/projects/Interview-Notebook/pics/85c05fb1-5546-4c50-9221-21f231cdc8c5.jpg)

- **版本**  : 有 4（IPv4）和 6（IPv6）两个值；

- **首部长度**  : 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为首部固定长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。

- **区分服务**  : 用来获得更好的服务，一般情况下不使用。

- **总长度**  : 包括首部长度和数据部分长度。

- **标识**  : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。

- **片偏移**  : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。

![计算机网络 - 图40](https://static.bookstack.cn/projects/Interview-Notebook/pics/23ba890e-e11c-45e2-a20c-64d217f83430.png)

- **生存时间**  ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。

- **协议**  ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。

- **首部检验和**  ：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。

## IP 地址编址方式

IP 地址的编址方式经历了三个历史阶段：

1. 分类
2. 子网划分
3. 无分类

### 1. 分类

由两部分组成，网络号和主机号，其中不同分类具有不同的网络号长度，并且是固定的。

IP 地址 ::= {< 网络号 >, < 主机号 >}

![计算机网络 - 图41](https://static.bookstack.cn/projects/Interview-Notebook/pics/cbf50eb8-22b4-4528-a2e7-d187143d57f7.png)

### 2. 子网划分

通过在主机号字段中拿一部分作为子网号，把两级 IP 地址划分为三级 IP 地址。注意，外部网络看不到子网的存在。

IP 地址 ::= {< 网络号 >, < 子网号 >, < 主机号 >}

要使用子网，必须配置子网掩码。一个 B 类地址的默认子网掩码为 255.255.0.0，如果 B 类地址的子网占两个比特，那么子网掩码为 11111111 11111111 11000000 00000000，也就是 255.255.192.0。

### 3. 无分类

无分类编址 CIDR 消除了传统 A 类、B 类和 C 类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化。

IP 地址 ::= {< 网络前缀号 >, < 主机号 >}

CIDR 的记法上采用在 IP 地址后面加上网络前缀长度的方法，例如 128.14.35.7/20 表示前 20 位为网络前缀。

CIDR 的地址掩码可以继续称为子网掩码，子网掩码首 1 长度为网络前缀的长度。

一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为路由聚合，也称为  **构成超网**  。

在路由表中的项目由“网络前缀”和“下一跳地址”组成，在查找时可能会得到不止一个匹配结果，应当采用最长前缀匹配来确定应该匹配哪一个。

## IP 地址和 MAC 地址

网络层实现主机之间的通信，而链路层实现具体每段链路之间的通信。因此在通信过程中，IP 数据报的源地址和目的地址始终不变，而 MAC 地址随着链路的改变而改变。

## 地址解析协议 ARP

实现由 IP 地址得到 MAC 地址。

## 分组网间探测 PING

PING 是 ICMP 的一个重要应用，主要用来测试两台主机之间的连通性。

Ping 发送的 IP 数据报封装的是无法交付的 UDP 用户数据报。

Ping 的过程：

1. 源主机向目的主机发送一连串的 IP 数据报。第一个数据报 P1 的生存时间 TTL 设置为 1，但 P1 到达路径上的第一个路由器 R1 时，R1 收下它并把 TTL 减 1，此时 TTL 等于 0，R1 就把 P1 丢弃，并向源主机发送一个 ICMP 时间超过差错报告报文；
2. 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达 R1，R1 收下后把 TTl 减 1 再转发给 R2，R2 收下后也把 TTL 减 1，由于此时 TTL 等于 0，R2 就丢弃 P2，并向源主机发送一个 ICMP 时间超过差错报文。
3. 不断执行这样的步骤，知道最后一个数据报刚刚到达目的主机，主机不转发数据报，也不把 TTL 值减 1。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文。
4. 之后源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间。

## 虚拟专用网 VPN

由于 IP 地址的紧缺，一个机构能申请到的 IP 地址数往往远小于本机构所拥有的主机数。并且一个机构并不需要把所有的主机接入到外部的互联网中，机构内的计算机可以使用仅在本机构有效的 IP 地址（专用地址）。

有三个专用地址块：

1. 10.0.0.0 ~ 10.255.255.255
2. 172.16.0.0 ~ 172.31.255.255
3. 192.168.0.0 ~ 192.168.255.255

VPN 使用公用的互联网作为本机构各专用网之间的通信载体。专用指机构内的主机只与本机构内的其它主机通信；虚拟指“好像是”，而实际上并不是，它有经过公用的互联网。

下图中，场所 A 和 B 的通信部经过互联网，如果场所 A 的主机 X 要和另一个场所 B 的主机 Y 通信，IP 数据报的源地址是 10.1.0.1，目的地址是 10.2.0.3。数据报先发送到与互联网相连的路由器 R1，R1 对内部数据进行加密，然后重新加上数据报的首部，源地址是路由器 R1 的全球地址 125.1.2.3，目的地址是路由器 R2 的全球地址 194.4.5.6。路由器 R2 收到数据报后将数据部分进行解密，恢复原来的数据报，此时目的地址为 10.2.0.3，就交付给 Y。

![计算机网络 - 图51](https://static.bookstack.cn/projects/Interview-Notebook/pics/1556770b-8c01-4681-af10-46f1df69202c.jpg)

## 网络地址转换 NAT

专用网内部的主机使用本地 IP 地址又想和互联网上的主机通信时，可以使用 NAT 来将本地 IP 转换为全球 IP。

在以前，NAT 将本地 IP 和全球 IP 一一对应，这种方式下拥有 n 个全球 IP 地址的专用网内最多只可以同时有 n 台主机接入互联网。为了更有效地利用全球 IP 地址，现在常用的 NAT 转换表把运输层的端口号也用上了，使得多个专用网内部的主机共用一个全球 IP 地址。使用端口号的 NAT 也叫做网络地址与端口转换 NAPT。

![计算机网络 - 图52](https://static.bookstack.cn/projects/Interview-Notebook/pics/2719067e-b299-4639-9065-bed6729dbf0b.png)


