# 一：操作系统概述

操作系统知识模块主要分为：操作系统概述、进程管理、内存管理、文件管理、输入/输出(I/O)管理。

操作系统（Operating System，OS）是指控制和管理整个计算机系统的硬件和软件资源，并合理地组织调度计算机的工作和资源分配，以提供给用户和其他软件方便的接口和环境的程序集合。  
操作系统的**基本特征包括：并发、共享、虚拟和异步**。

- 并发：并发是指两个或者两个以上的事件在同一时间间隔中发生。并行需要硬件的支持，如多流水线多处理器。  操作系统引入进程与线程，用于并发。
- 虚拟是指把一个物理上的实体转变为若干个逻辑上的对应物，操作系统的虚拟技术可归纳为：时分复用技术，如处理器的分时共享；空分复用技术，如虚拟存储器。
- 异步：是指在多道程序环境下，允许多个程序并发执行，但由于自由有限，进程的执行不是一贯到底，而是走走停停，以不可知的速度向前推进，这就是进程的异步性。
- 共享：共享是指系统中的资源可以提供多个并发进程共同使用，有两种共享方式，互斥共享（相当于加锁）和同时共享。互斥共享的资源称为临界资源，例如打印机等，在同一时间只允许一个进程访问，需要用同步机制来实现对临界资源的访问。

### 操作系统的基本功能

#### 1:进程管理

进程控制、进程同步、进程通信、死锁处理、处理机调度等。

#### 2:内存管理

内存分配、地址映射、内存保护与共享和内存扩充等功能。

#### 3:文件管理

文件存储空间的管理、目录管理及文件读写管理和保护等。

#### 4:设备管理

完成用户的 I/O 请求，方便用户使用各种设备，并提高设备的利用率，主要包括缓冲管理、设备分配、设备处理和虛拟设备等功能。



# 二：内存管理

## 虚拟内存

虚拟内存的目的是为了让物理内存扩充为更大的逻辑内存，从而让程序获得更多的内存空间。

操作系统将内存抽象为地址空间，每个程序拥有自己的地址空间，这个地址空间被分割为多个块，每一块称为一页。 这些页被映射到了物理内存，但并不需要映射到连续的物理内存，也不需要所有页都必须在物理内存中。当程序引用不到不在物理内存中的页时，由硬件执行必要的映射，将缺失的部分重新装入内存中并重新执行失败的指令。

虚拟内存允许程序不用将地址空间中的每一页都映射到物理内存，也就是说一个程序不需要全部调入内存就可以运行，这使得有限的内存运行大程序成为可能。例如有一台计算机可以产生 16 位地址，那么一个程序的地址空间范围是 0~64K。该计算机只有 32KB 的物理内存，虚拟内存技术允许该计算机运行一个 64K 大小的程序。

## 分页系统地址映射

内存管理单元（MMU）管理着地址空间和物理内存的转换，其中的页表（page table）存储着页（程序地址空间）和页框（物理内存空间）的映射表。

一个虚拟地址分成两个部分，一部分存储页面号，一部分存储偏移量。

下图的页表存放着 16 个页，这 16 个页需要用 4 个比特位来进行索引定位。例如对于虚拟地址（0010 000000000100），前 4 位是存储页面号 2，读取表项内容为（110 1），页表项最后一位表示是否存在于内存中，1 表示存在。后 12 位存储偏移量。这个页对应的页框的地址为 （110 000000000100）。

![images\页框例子](images\页框例子.png)



## 页面置换算法

该算法就是将程序中的页装载到物理内存中（因为虚拟内存不必将所有的页都装入物理内存中执行）。在程序运行过程中，如果要访问的页面不在内存中，就发生缺页中断从而将该页调入内存中。此时如果内存已无空闲空间，系统必须从内存中调出一个页面到磁盘对换区中来腾出空间。

页面置换算法和缓存淘汰策略类似，可以将内存看成磁盘的缓存。在缓存系统中，缓存的大小有限，当有新的缓存到达时，需要淘汰一部分已经存在的缓存，这样才有空间存放新的缓存数据。

页面置换算法的主要目标是使页面置换频率最低（也可以说缺页率最低）。

### 1. 最佳

> OPT, Optimal replacement algorithm

所选择的被换出的页面将是最长时间内不再被访问，通常可以保证获得最低的缺页率。

是一种理论上的算法，因为无法知道一个页面多长时间不再被访问。

举例：一个系统为某进程分配了三个物理块，并有如下页面引用序列：

```html
7，0，1，2，0，3，0，4，2，3，0，3，2，1，2，0，1，7，0，1
```

开始运行时，先将 7, 0, 1 三个页面装入内存。当进程要访问页面 2 时，产生缺页中断，会将页面 7 换出，因为页面 7 再次被访问的时间最长。

### 2：最近最久未使用

> LRU  (也是常见的缓存淘汰策略)

虽然无法知道将来要使用的页面情况，但是可以知道过去使用页面的情况。LRU 将最近最久未使用的页面换出。

为了实现 LRU，需要在内存中维护一个所有页面的链表。当一个页面被访问时，将这个页面移到链表表头。这样就能保证链表表尾的页面是最近最久未访问的。

因为每次访问都需要更新链表，因此这种方式实现的 LRU 代价很高。

### 3：最近未使用

>  NRU, Not Recently Used

每个页面都有两个状态位：R 与 M，当页面被访问时设置页面的 R=1，当页面被修改时设置 M=1。其中 R 位会定时被清零。可以将页面分成以下四类：

- R=0，M=0
- R=0，M=1
- R=1，M=0
- R=1，M=1

当发生缺页中断时，NRU 算法随机地从类编号最小的非空类中挑选一个页面将它换出。

NRU 优先换出已经被修改的脏页面（R=0，M=1），而不是被频繁使用的干净页面（R=1，M=0）。

### 4. 先进先出

> FIFO, First In First Out

选择换出的页面是最先进入的页面。

该算法会将那些经常被访问的页面也被换出，从而使缺页率升高。

### 5.第二次机会算法

FIFO 算法可能会把经常使用的页面置换出去，为了避免这一问题，对该算法做一个简单的修改：

当页面被访问 (读或写) 时设置该页面的 R 位为 1。需要替换的时候，检查最老页面的 R 位。如果 R 位是 0，那么这个页面既老又没有被使用，可以立刻置换掉；如果是 1，就将 R 位清 0，并把该页面放到链表的尾端，修改它的装入时间使它就像刚装入的一样，然后继续从链表的头部开始搜索。

### 6.时钟

> Clock

![images\时钟页面置换算法](images\时钟页面置换算法.png)

第二次机会算法需要在链表中移动页面，降低了效率。时钟算法使用环形链表将页面连接起来，再使用一个指针指向最老的页面。



## 分段

虚拟内存采用的是分页技术，也就是将地址空间划分为固定大小的页，每一页与内存进行映射。

下图为一个编译器在编译过程中建立的多个表，有 4 个表是动态增长的，如果使用分页系统的一维地址空间，动态增长的特点会导致覆盖问题的出现。

![images\分页动态缺陷](images\分页动态缺陷.png)



而分段的做法就是把每个表分成段，一个段构成一个独立的空间，每个段的长度可以不同，并且可以动态增长。 这就解决了动态增长的覆盖问题。

![images\分段](images\分段.png)

### 段页式

程序的地址空间划分为多个拥有独立地址空间的段，每个段上的地址空间划分为大小相同的页。这样既有了分段系统的共享与保护，也有了分页系统的虚拟内存功能。

## 分页与分段的比较

- 对程序的透明性:分页透明，但是分页需要程序员显示划分每个段。

- 地址空间的维度：分页是一维的，分段式二维的；

- 大小是否可以改变：页的大小不可变，段的大小可以动态改变。

- 出现的原因：分页主要用于实现虚拟内存，从而获得更大的地址空间；分段主要是为了使程序和数据可以被划分为逻辑上独立的地址空间并且有助于共享和保护。

# 三：设备管理

操作系统中的主要设备就是磁盘。

## 磁盘结构

- 盘面（Platter）：一个磁盘有多个盘面；
- 磁道（Track）：盘面上的圆形带状区域，一个盘面可以有多个磁道；
- 扇区（Track Sector）：磁道上的一个弧段，一个磁道可以有多个扇区，它是最小的物理储存单位，目前主要有 512 bytes 与 4 K 两种大小；
- 磁头（Head）：与盘面非常接近，能够将盘面上的磁场转换为电信号（读），或者将电信号转换为盘面的磁场（写）；
- 制动手臂（Actuator arm）：用于在磁道之间移动磁头；
- 主轴（Spindle）：使整个盘面转动。

## 磁盘的调度算法

读写一个词块的时间的影响因素有：

- 旋转时间（主轴转动盘面，使得磁头移动到适当的扇区上）
- 寻道时间（制动手臂移动，使得磁头移动到适当的磁道上）
- 实际的数据传输时间

其中，寻道时间最长，因此磁盘调度的主要目标是使磁盘的平均寻道时间最短。

### 1:先来先去服务

>  FCFS, First Come First Served

按照磁盘的请求顺序进行调度。

优点是公平与简单，缺点也很明显，未对寻道做任何优化，使平均时道时间可能较长。

### 2:最短时间寻道优先

> SSTF, Shortest Seek Time First

优先调度与当前磁头所在磁道距离最近的磁道。

虽然平均寻道时间比较低，但是不够公平。如果新到达的磁道请求总是比一个在等待的磁道请求近，那么在等待的磁道请求会一直等待下去，也就是出现饥饿现象。具体来说，两端的磁道请求更容易出现饥饿现象。（类似于线程抢锁（非公平），有的等待的线程可能会一直抢不到）。

## 3. 电梯算法

> SCAN

电梯总是保持一个方向运行，直到该方向没有请求为止，然后改变运行方向。

电梯算法（扫描算法）和电梯的运行过程类似，总是按一个方向来进行磁盘调度，直到该方向上没有未完成的磁盘请求，然后改变方向。

因为考虑了移动方向，因此所有的磁盘请求都会被满足，解决了 SSTF 的饥饿问题。



## 总结：

本节主要学习了操作系统的一些基本概念，内存管理和系统管理。

操作系统的基本特性有并发，共享，虚拟和异步，掌握这四点的概念。

操作系统的功能有：内存管理，设备管理，进程管理，文件管理。

今天主要学习了内存管理与设备管理：

在内存管理中，掌握虚拟内存的概念，目的是将物理地址扩充为更大的逻辑地址，操作系统将程内存抽象为地址空间，每个地址空间单元称为页，程序在运行时，将部分页映射到物理地址空间，不允许将所有的页都映射物理内存地址中，通过分页置换算法，将程序运行时引用不存在的页映射到物理地址空间， 这样就可以让32k的物理地址运行64k的程序。

分页置换算法的方式有6种：最佳算法（所选出的被换出的页时长时间不能被访问的）， LRU（最近最久未使用），NRU（最近未使用），先进先出，第二次机会算法，时钟算法，了解这几种算法的原理。

分段：分页是一维的（因为每个页的大小空间不变），在存储动态表，动态表的增长容易发生页的覆盖问题。 所以将每个表划分为段，每个段都有一个独立的空间，并且可以动态增长。

段页式：程序将空间分为了多个拥有独立地址空间的段，每个段上的地址空间又划分为多个大小相同的页。

分页与分段的区别：分页是为了使用虚拟内存，分段是为了使程序和数据被划分为逻辑上的独立单元，可以更好地共享与保护。 分页的大小是固定的，分段的大小是动态增长的。 把分页类比于链表，每个节点都是固定大小，把分段技术类比于动态扩容的数组。

然后学习了设备管理中的磁盘的三种调度算法：先来先去算法（公平，但是无优化，通道等待时间可能较长），最短时间寻道优先（优先调度寻道最短的位置，但是两端的磁道容易产生饥饿现象），电梯算法（向一个方向寻道完了，再回升到寻道，类似于电梯）。




